<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AlsaTalk</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }

        .input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-wrapper:hover {
            border-color: var(--primary);
            background: rgba(6, 182, 212, 0.05);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-wrapper label {
            font-size: 0.9375rem;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }

        .create-user-btn {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.875rem 1.75rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .create-user-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.4);
        }

        .create-user-btn:active {
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }

        #errorMessage:not(.hidden) {
            display: flex;
        }

        /* Loader Styles */
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Simple Header -->
    <div style="background: var(--bg-secondary); border-bottom: 1px solid var(--glass-border); padding: 1.5rem 2rem;">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="logo_large_1024.png" alt="AlsaTalk Logo" style="width: 40px; height: 40px; border-radius: 8px;">
                <div>
                    <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0;">User Management</h1>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Admin Panel</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="adminUsername" style="color: var(--text-primary); font-size: 0.875rem; font-weight: 500;"></span>
                <a href="/" class="nav-btn-secondary" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                    <i data-lucide="home" style="width: 16px; height: 16px;"></i>
                    <span>Home</span>
                </a>
                <form action="/logout" method="POST" style="margin: 0;">
                    <button type="submit" class="nav-btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div style="max-width: 1400px; margin: 2rem auto; padding: 0 2rem;">
        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="feature-card" style="padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(6, 182, 212, 0.15); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="users" style="width: 24px; height: 24px; color: var(--primary);"></i>
                    </div>
                    <div>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Total Users</p>
                        <p id="totalUsers" style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0.25rem 0 0 0;">0</p>
                    </div>
                </div>
            </div>
            <div class="feature-card" style="padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(16, 185, 129, 0.15); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: var(--success);"></i>
                    </div>
                    <div>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Active Users</p>
                        <p id="activeUsers" style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0.25rem 0 0 0;">0</p>
                    </div>
                </div>
            </div>
            <div class="feature-card" style="padding: 1.5rem; cursor: pointer;" onclick="scrollToPending()">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(251, 146, 60, 0.15); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="clock" style="width: 24px; height: 24px; color: #fb923c;"></i>
                    </div>
                    <div>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">Pending Approval</p>
                        <p id="pendingUsers" style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0.25rem 0 0 0;">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Registrations -->
        <div id="pendingSection" class="feature-card" style="margin-bottom: 2rem; display: none;">
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--glass-border);">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i data-lucide="clock" style="width: 20px; height: 20px; color: #fb923c;"></i>
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">Pending Registrations</h2>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">Review and approve new user registrations</p>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--glass-border);">
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Name</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Email</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Phone</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Type</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Registered</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Table -->
        <div class="feature-card">
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">Users</h2>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">Manage user accounts and permissions</p>
                </div>
                <button onclick="openCreateModal()" class="create-user-btn">
                    <i data-lucide="user-plus" style="width: 18px; height: 18px;"></i>
                    <span>Create User</span>
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--glass-border);">
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">User</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Email</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Role</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Token Usage</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Status</th>
                            <th style="padding: 1.25rem 2rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px); align-items: center; justify-content: center; z-index: 50; overflow-y: auto;">
        <div class="feature-card" style="max-width: 800px; width: 90%; margin: 2rem auto; max-height: 90vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease;">
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--glass-border); flex-shrink: 0;">
                <h3 id="modalTitle" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0;">Create New User</h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">Add a new user to the system</p>
            </div>

            <form id="userForm" style="padding: 2rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; overflow-y: auto; flex: 1;">
                <input type="hidden" id="userId">

                <!-- Username -->
                <div style="grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Username <span style="color: var(--error);">*</span>
                    </label>
                    <input
                        type="text"
                        id="username"
                        required
                        class="input-field"
                        placeholder="Enter username"
                    >
                </div>

                <!-- Email -->
                <div style="grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Email Address <span style="color: var(--error);">*</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        required
                        class="input-field"
                        placeholder="user@example.com"
                    >
                </div>

                <!-- Full Name -->
                <div style="grid-column: span 2;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Full Name
                    </label>
                    <input
                        type="text"
                        id="fullName"
                        class="input-field"
                        placeholder="Enter full name (optional)"
                    >
                </div>

                <!-- Phone Number -->
                <div id="phoneField" style="display: none; grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Phone Number
                    </label>
                    <input
                        type="text"
                        id="phoneNumber"
                        class="input-field"
                        placeholder="Phone number"
                        readonly
                    >
                </div>

                <!-- WhatsApp Number -->
                <div id="whatsappField" style="display: none; grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        WhatsApp Number
                    </label>
                    <input
                        type="text"
                        id="whatsappNumber"
                        class="input-field"
                        placeholder="WhatsApp number"
                        readonly
                    >
                </div>

                <!-- Address -->
                <div id="addressField" style="display: none; grid-column: span 2;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Address
                    </label>
                    <textarea
                        id="address"
                        class="input-field"
                        placeholder="Address"
                        rows="2"
                        readonly
                    ></textarea>
                </div>

                <!-- Company Name -->
                <div id="companyField" style="display: none; grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Company Name
                    </label>
                    <input
                        type="text"
                        id="companyName"
                        class="input-field"
                        placeholder="Company name"
                        readonly
                    >
                </div>

                <!-- User Type -->
                <div id="userTypeField" style="display: none; grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        User Type
                    </label>
                    <input
                        type="text"
                        id="userType"
                        class="input-field"
                        placeholder="User type"
                        readonly
                    >
                </div>

                <!-- Token Usage (Display Only) -->
                <div id="tokenUsageField" style="display: none; grid-column: span 2;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Current Token Usage
                    </label>
                    <div style="padding: 0.875rem 1rem; background: var(--bg-primary); border: 1px solid var(--glass-border); border-radius: 10px;">
                        <div style="font-size: 0.875rem; color: var(--text-primary); margin-bottom: 0.5rem;">
                            <span id="tokensUsed">0</span> / <span id="tokensLimit">10000</span> tokens
                        </div>
                        <div style="width: 100%; height: 8px; background: rgba(148, 163, 184, 0.2); border-radius: 4px; overflow: hidden;">
                            <div id="tokenProgressBar" style="height: 100%; width: 0%; background: var(--primary); border-radius: 4px; transition: all 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            <span id="tokenPercentage">0%</span> used
                        </div>
                    </div>
                </div>

                <!-- Password -->
                <div id="passwordField" style="grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Password <span style="color: var(--error);">*</span>
                    </label>
                    <input
                        type="password"
                        id="password"
                        class="input-field"
                        placeholder="Minimum 6 characters"
                    >
                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin: 0.5rem 0 0 0;">
                        <i data-lucide="info" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                        Password must be at least 6 characters
                    </p>
                </div>

                <!-- Token Limit -->
                <div style="grid-column: span 1;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Token Limit <span style="color: var(--error);">*</span>
                    </label>
                    <input
                        type="number"
                        id="tokenLimit"
                        value="10000"
                        min="0"
                        class="input-field"
                        placeholder="Enter token limit"
                    >
                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin: 0.5rem 0 0 0;">
                        <i data-lucide="info" style="width: 12px; height: 12px; display: inline; vertical-align: middle;"></i>
                        Maximum number of tokens this user can consume
                    </p>
                </div>

                <!-- Permissions -->
                <div style="grid-column: span 2; display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">
                        Permissions
                    </label>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="isAdmin">
                            <label for="isAdmin">Admin privileges</label>
                        </div>

                        <div class="checkbox-wrapper" id="statusField" style="display: none;">
                            <input type="checkbox" id="isActive" checked>
                            <label for="isActive">Active account</label>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="hidden" style="grid-column: span 2; padding: 1rem; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); border-radius: 10px; color: var(--error); font-size: 0.875rem; align-items: center; gap: 0.75rem;">
                    <i data-lucide="alert-circle" style="width: 20px; height: 20px;"></i>
                    <span id="errorText"></span>
                </div>
            </form>

            <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0;">
                <button onclick="closeUserModal()" class="nav-btn-secondary" style="padding: 0.75rem 1.5rem;" id="cancelBtn">
                    Cancel
                </button>
                <button onclick="saveUser()" class="cta-button" style="padding: 0.75rem 2rem; display: flex; align-items: center; gap: 0.5rem;" id="saveBtn">
                    <i data-lucide="check" style="width: 16px; height: 16px;" id="saveIcon"></i>
                    <div class="loader hidden" id="saveLoader"></div>
                    <span id="saveBtnText">Save User</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                document.getElementById('activeUsers').textContent = data.activeUsers || 0;
                document.getElementById('pendingUsers').textContent = data.pendingUsers || 0;
                setTimeout(() => lucide.createIcons(), 10);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadPendingUsers() {
            try {
                const response = await fetch('/api/admin/pending');
                const data = await response.json();
                displayPendingUsers(data.users || []);
            } catch (error) {
                console.error('Error loading pending users:', error);
            }
        }

        function displayPendingUsers(users) {
            const tbody = document.getElementById('pendingTableBody');
            const section = document.getElementById('pendingSection');

            if (users.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            tbody.innerHTML = users.map(user => `
                <tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 1.25rem 2rem;">
                        <div style="font-weight: 600; font-size: 0.9375rem; color: var(--text-primary);">${user.full_name}</div>
                        ${user.company_name ? `<div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem;">${user.company_name}</div>` : ''}
                    </td>
                    <td style="padding: 1.25rem 2rem; color: var(--text-secondary); font-size: 0.9375rem;">${user.email}</td>
                    <td style="padding: 1.25rem 2rem; color: var(--text-secondary); font-size: 0.9375rem;">
                        <div>${user.phone_number}</div>
                        ${user.whatsapp_number && user.whatsapp_number !== user.phone_number ? `<div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem;">WA: ${user.whatsapp_number}</div>` : ''}
                    </td>
                    <td style="padding: 1.25rem 2rem;">
                        <span style="padding: 0.375rem 0.875rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: rgba(148, 163, 184, 0.15); color: var(--text-muted); text-transform: capitalize;">
                            ${user.user_type}
                        </span>
                    </td>
                    <td style="padding: 1.25rem 2rem; color: var(--text-secondary); font-size: 0.875rem;">
                        ${new Date(user.created_at).toLocaleDateString()}
                    </td>
                    <td style="padding: 1.25rem 2rem;">
                        <div style="display: flex; gap: 0.75rem;">
                            <button onclick="approveUser(${user.id})" style="padding: 0.5rem 1rem; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Approve
                            </button>
                            <button onclick="rejectUser(${user.id})" style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.15); color: var(--error); border: 1px solid var(--error); border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            setTimeout(() => lucide.createIcons(), 10);
        }

        async function approveUser(userId) {
            if (!confirm('Approve this user registration? They will receive an email with verification instructions.')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('User approved successfully! Verification email sent.');
                    loadPendingUsers();
                    loadStats();
                    loadUsers();
                } else {
                    alert(data.error || 'Failed to approve user');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Reject this registration? This will permanently delete the user account.')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Registration rejected successfully.');
                    loadPendingUsers();
                    loadStats();
                } else {
                    alert(data.error || 'Failed to reject user');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function scrollToPending() {
            document.getElementById('pendingSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                displayUsers(data.users);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (!data.authenticated || !data.user.isAdmin) {
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('adminUsername').textContent = `Welcome, ${data.user.fullName || data.user.username}!`;
            } catch (error) {
                window.location.href = '/login';
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = users.map(user => {
                const tokensUsed = user.tokens_used || 0;
                const tokenLimit = user.token_limit || 10000;
                const percentage = tokenLimit > 0 ? Math.round((tokensUsed / tokenLimit) * 100) : 0;
                const isNearLimit = percentage >= 80;
                const isAtLimit = percentage >= 100;

                return `
                <tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 1.25rem 2rem;">
                        <div style="font-weight: 600; font-size: 0.9375rem; color: var(--text-primary);">${user.username}</div>
                        ${user.full_name ? `<div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem;">${user.full_name}</div>` : ''}
                    </td>
                    <td style="padding: 1.25rem 2rem; color: var(--text-secondary); font-size: 0.9375rem;">${user.email}</td>
                    <td style="padding: 1.25rem 2rem;">
                        <span style="padding: 0.375rem 0.875rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; ${user.is_admin ? 'background: rgba(139, 92, 246, 0.2); color: var(--secondary);' : 'background: rgba(148, 163, 184, 0.15); color: var(--text-muted);'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td style="padding: 1.25rem 2rem;">
                        <div style="font-size: 0.875rem; color: var(--text-primary);">
                            ${tokensUsed.toLocaleString()} / ${tokenLimit.toLocaleString()}
                        </div>
                        <div style="width: 100%; max-width: 120px; height: 6px; background: rgba(148, 163, 184, 0.2); border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(percentage, 100)}%; background: ${isAtLimit ? 'var(--error)' : isNearLimit ? '#fb923c' : 'var(--primary)'}; border-radius: 3px; transition: all 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: ${isAtLimit ? 'var(--error)' : isNearLimit ? '#fb923c' : 'var(--text-muted)'}; margin-top: 0.25rem;">
                            ${percentage}% used
                        </div>
                    </td>
                    <td style="padding: 1.25rem 2rem;">
                        <span style="padding: 0.375rem 0.875rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; ${user.is_active ? 'background: rgba(16, 185, 129, 0.2); color: var(--success);' : 'background: rgba(239, 68, 68, 0.2); color: var(--error);'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td style="padding: 1.25rem 2rem;">
                        <button onclick="editUser(${user.id})" style="color: var(--primary); margin-right: 1.25rem; cursor: pointer; background: none; border: none; font-weight: 600; font-size: 0.875rem;">Edit</button>
                        <button onclick="deleteUser(${user.id})" style="color: var(--error); cursor: pointer; background: none; border: none; font-weight: 600; font-size: 0.875rem;">Delete</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordField').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('statusField').style.display = 'none';

            // Hide user detail fields (only for edit mode)
            document.getElementById('phoneField').style.display = 'none';
            document.getElementById('whatsappField').style.display = 'none';
            document.getElementById('addressField').style.display = 'none';
            document.getElementById('companyField').style.display = 'none';
            document.getElementById('userTypeField').style.display = 'none';
            document.getElementById('tokenUsageField').style.display = 'none';

            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('userModal').classList.add('active');
            setTimeout(() => lucide.createIcons(), 10);
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const fullName = document.getElementById('fullName').value;
            const password = document.getElementById('password').value;
            const tokenLimit = parseInt(document.getElementById('tokenLimit').value) || 10000;
            const isAdmin = document.getElementById('isAdmin').checked;
            const isActive = document.getElementById('isActive').checked;

            // Show loader
            showLoader(true);

            try {
                let response;
                if (userId) {
                    response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, fullName, tokenLimit, isAdmin, isActive })
                    });
                } else {
                    if (!password || password.length < 6) {
                        showError('Password must be at least 6 characters');
                        showLoader(false);
                        return;
                    }
                    response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password, fullName, tokenLimit, isAdmin })
                    });
                }

                const data = await response.json();
                if (response.ok) {
                    closeUserModal();
                    loadUsers();
                    showLoader(false);
                } else {
                    showError(data.error || 'Failed to save user');
                    showLoader(false);
                }
            } catch (error) {
                showError('Network error. Please try again.');
                showLoader(false);
            }
        }

        async function editUser(userId) {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);

                if (user) {
                    document.getElementById('modalTitle').textContent = 'Edit User';
                    document.getElementById('userId').value = user.id;
                    document.getElementById('username').value = user.username;
                    document.getElementById('email').value = user.email;
                    document.getElementById('fullName').value = user.full_name || '';
                    document.getElementById('tokenLimit').value = user.token_limit || 10000;
                    document.getElementById('isAdmin').checked = user.is_admin;
                    document.getElementById('isActive').checked = user.is_active;

                    // Show additional user details if they exist
                    if (user.phone_number) {
                        document.getElementById('phoneNumber').value = user.phone_number;
                        document.getElementById('phoneField').style.display = 'block';
                    }
                    if (user.whatsapp_number) {
                        document.getElementById('whatsappNumber').value = user.whatsapp_number;
                        document.getElementById('whatsappField').style.display = 'block';
                    }
                    if (user.address) {
                        document.getElementById('address').value = user.address;
                        document.getElementById('addressField').style.display = 'block';
                    }
                    if (user.company_name) {
                        document.getElementById('companyName').value = user.company_name;
                        document.getElementById('companyField').style.display = 'block';
                    }
                    if (user.user_type) {
                        document.getElementById('userType').value = user.user_type.charAt(0).toUpperCase() + user.user_type.slice(1);
                        document.getElementById('userTypeField').style.display = 'block';
                    }

                    // Show token usage stats
                    const tokensUsed = user.tokens_used || 0;
                    const tokenLimit = user.token_limit || 10000;
                    const percentage = tokenLimit > 0 ? Math.round((tokensUsed / tokenLimit) * 100) : 0;
                    const isNearLimit = percentage >= 80;
                    const isAtLimit = percentage >= 100;

                    document.getElementById('tokensUsed').textContent = tokensUsed.toLocaleString();
                    document.getElementById('tokensLimit').textContent = tokenLimit.toLocaleString();
                    document.getElementById('tokenPercentage').textContent = percentage + '%';
                    document.getElementById('tokenProgressBar').style.width = Math.min(percentage, 100) + '%';
                    document.getElementById('tokenProgressBar').style.background = isAtLimit ? 'var(--error)' : isNearLimit ? '#fb923c' : 'var(--primary)';
                    document.getElementById('tokenUsageField').style.display = 'block';

                    document.getElementById('passwordField').style.display = 'none';
                    document.getElementById('password').required = false;
                    document.getElementById('statusField').style.display = 'flex';
                    document.getElementById('errorMessage').classList.add('hidden');
                    document.getElementById('userModal').classList.add('active');
                    setTimeout(() => lucide.createIcons(), 10);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete user');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => lucide.createIcons(), 10);
        }

        function showLoader(show) {
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const saveIcon = document.getElementById('saveIcon');
            const saveLoader = document.getElementById('saveLoader');
            const saveBtnText = document.getElementById('saveBtnText');

            if (show) {
                // Show loader
                saveBtn.classList.add('btn-loading');
                cancelBtn.disabled = true;
                cancelBtn.style.opacity = '0.5';
                saveIcon.classList.add('hidden');
                saveLoader.classList.remove('hidden');
                saveBtnText.textContent = 'Saving...';
            } else {
                // Hide loader
                saveBtn.classList.remove('btn-loading');
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                saveIcon.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtnText.textContent = 'Save User';
                setTimeout(() => lucide.createIcons(), 10);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeUserModal();
        });

        checkAuth();
        loadStats();
        loadPendingUsers();
        loadUsers();
    </script>
</body>
</html>
